---
title: "ARM tempate DSL、Bicep デプロイのベストプラクティス"
emoji: "💪"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["azure", "arm", "bicep", "応用"]
published: true
---

本稿は、Bicepを使ったデプロイのベストプラクティスの考察です。俗にポエムとも言います。

要件

- ポータビリティ
- 再利用性の向上
- 環境依存の排除
- 修正容易性

結局、docker + linux が一番優れている。そこには、WindowsもMacも無い。

デプロイするとき、なんだかんだ言って、前準備が必要なものがある。つまりデプロイまえに、なにかやってからデプロイすることになる。az cli でデプロイするとしても、VMをデプロイするときには、ssh keyが必要だったり、nsgの場合は、設定のJSONが必要だったりする。複数のプロセスをなんらかのルールで実行する必要があるので、何らかのTask Runnerが必要だ。

つまり、前処理、デプロイ、後処理のような形で決まったタスクを実行する仕組みが欲しい、あとタスクを実行するときには、何らかの方法で設定を渡せる必要がある。例えば、決まったリソースグループにしかデプロイできない仕組みだと、柔軟性が低すぎる。これだと複数のチームで別環境を持って開発するときに、同じ仕組みでAzure環境を構築する場合は、サブスクリプションを分ける必要がある。これだと、現実的ではない。デプロイ時にリソースグループを指定出来る必要がある。ここでは、リソースグループの話をしたが、他にもいろいろなパラメータが想定される。ロケーションとか、SKUもそうだ。

古来、Task Runnerは何度も必要とされ開発されてきた。個人的にも、昔、開発がC主体であったときは、make を、Javaのときは、ant に始まって、maven を、C#の時は、nant に始まって、msbuild を、powershellの時は、psake をと様々なTask Runner を使ってきた。(cmakeは使っていない) また、シェルスクリプトやperl, python、powershell などのスクリプトをTask Runner的に使うこともあった。

まず言えるのは、Task Runner は手続き的なものよりは、宣言的なものが望ましい。手続きを記述して行くよりも、Taskを記載して、Taskの依存関係で実行の必要、不必要と順番が決まる方が、使いやすく理解しやすい。
